generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum FriendshipStatus {
  PENDING
  FRIEND
  CLOSE_FRIEND
  BLOCKED
}

enum FeedStatus {
  PUBLIC
  FRIEND
  CLOSE_FRIEND
}

model User {
  id           String   @id @default(cuid())
  username     String   @unique(map: "users_username_key")
  passwordHash String
  createdAt    DateTime @default(now())

  feeds    Feed[]
  comments Comment[]
  likes    FeedLike[]

  friendshipsRequested Friendship[] @relation("FriendRequests")
  friendshipsReceived  Friendship[] @relation("FriendTargets")
}

model Friendship {
  id          String           @id @default(cuid())
  requester   User             @relation("FriendRequests", fields: [requesterId], references: [id])
  requesterId String
  target      User             @relation("FriendTargets", fields: [targetId], references: [id])
  targetId    String
  status      FriendshipStatus
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([requesterId, targetId], map: "friend_unique_pair")
}

model Place {
  id          String  @id @default(cuid())
  name        String
  xCoord      Int // 캠퍼스 지도 이미지 기준 X 좌표(px)
  yCoord      Int // 캠퍼스 지도 이미지 기준 Y 좌표(px)
  description String?

  feeds Feed[]
}

model Feed {
  id        String     @id @default(cuid())
  author    User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId  String
  place     Place      @relation(fields: [placeId], references: [id], onDelete: Cascade)
  placeId   String
  content   String
  imageKey  String?
  status    FeedStatus
  createdAt DateTime   @default(now())

  comments Comment[]
  likes    FeedLike[]

  @@index([placeId, createdAt], map: "feeds_place_created_idx")
  @@index([authorId, createdAt], map: "feeds_author_created_idx")
}

model Comment {
  id        String   @id @default(cuid())
  feed      Feed     @relation(fields: [feedId], references: [id], onDelete: Cascade)
  feedId    String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId  String
  content   String
  createdAt DateTime @default(now())
}

model FeedLike {
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  feed      Feed     @relation(fields: [feedId], references: [id], onDelete: Cascade)
  feedId    String
  createdAt DateTime @default(now())

  @@id([userId, feedId])
}
